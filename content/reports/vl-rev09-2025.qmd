---
title: "Overview VL review extraction"
author: Thomas Brochhagen
date: today
format: html
code-fold: true

---


```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(knitr)

setwd('~')
df <- readr::read_csv('Downloads/extracted_N=356.csv')

```

This is an overview of the data from the systematic review's data extraction phase. A total of `r nrow(df)` studies went through this final phase of extraction (i.e., these are the relevant studies for the systematic review after screening). 

Here are the columns of the file

```{r}
print(colnames(df))
```

### Structural matters

Studies with missing data in at least one column:

```{r}
df[!complete.cases(df),] %>% select(`Covidence #`, Title, `Study ID`)
```

The columns `Covidence #`, `Title` and `Study ID` give similar information but note that there are repeated values in `Study ID` (printed below), so always use `Covidence #` as a unique identifier for each study. Repeated Study IDs:

```{r}
#length(unique(df$`Covidence #`))
#length(unique(df$`Title`))
df[duplicated(df$`Study ID`), ]$`Study ID`
```

Looking at the titles associated with `KROODSMA 1980` to check:
```{r}
df %>% filter(`Study ID` == 'KROODSMA 1980') %>% pull(Title)
```

So `Study ID` is non-unique when authors publish multiple papers in a single year.

### Vocalizer-related counts

In the following I am splitting multiple entries into individual entries. Recall that some studies are about multiple `Taxa`, or have multiple labels, and so on. For instance, a cell with `bats; cetaceans` means that the study is on both bats and cetaceans. To get counts, I split these into `bats` and `cetaceans`. So, after splitting, there are more than 356 entries for most of these columns.

Also, for normalization purposes, trailing spaces and enclosing square brackets were removed (e.g. `[Melospiza melodia]` vs. `Melospiza melodia`). And everything was lowercased. I don't remember what `+`, `x` and quotation marks (e.g., `“calliphlox” evelynae`) indicate so those were left untouched.

::: {.panel-tabset}
#### Taxa 
```{r}
split_and_expand <- function(string_vector) {
  split_list <- strsplit(string_vector, split = ";\\s*")
  expanded_vector <- unlist(split_list)
  norm_vector <- trimws(expanded_vector, which = "right")
  norm_vector <- gsub("\\[|\\]", "", norm_vector)
  norm_vector <- tolower(norm_vector)
  return(norm_vector)
}

taxa <- split_and_expand(df$Taxa)
species.scient <- split_and_expand(df$`Species (scientific name)`)
species.comm <- split_and_expand(df$`Species (common name)`)
mobility <- split_and_expand(df$Mobility)
voc.sex <- split_and_expand(df$`Vocalizer sex`)
int.receiver <- split_and_expand(df$`Intended receiver`)
age <- split_and_expand(df$`Age`)
vocalization.type <- split_and_expand(df$`Vocalization type`)
h.interaction <- split_and_expand(df$`Heterospecific interaction`)

addmargins(sort(table(taxa),decreasing = TRUE)) %>% kable()
```

#### Species scientific name
```{r}
addmargins(sort(table(species.scient), decreasing = TRUE)) %>% kable()
```

#### Species common name
```{r}
addmargins(sort(table(species.comm), decreasing = TRUE)) %>% kable()
```

#### Mobility
```{r}
addmargins(sort(table(mobility),decreasing = TRUE)) %>% kable()
```

#### Vocalizer sex
```{r}
addmargins(sort(table(voc.sex),decreasing = TRUE)) %>% kable()
```

#### Intended receiver
```{r}
addmargins(sort(table(int.receiver), decreasing = TRUE)) %>% kable()
```

#### Age
```{r}
addmargins(sort(table(age), decreasing = TRUE)) %>% kable()
```

#### Vocalization type
```{r}
addmargins(sort(table(vocalization.type),, decreasing = TRUE)) %>% kable()
```

#### Heterospecific interaction
```{r}
addmargins(sort(table(h.interaction), decreasing = TRUE)) %>% kable()
```
:::

To keep in mind for future data analysis/summary statistics: the `Sum` does not match across columns. For instance, `Taxa` has 360 entries but `Age` has `448`. That is probably due to, say, a study on a single taxon across multiple stages of ontological development. 



### Study-related counts

Same as above but for properties that are more about the study than the animal

```{r}
type <- split_and_expand(df$`Type of study`)
primary <- split_and_expand(df$`Primary evidence of VL`)
focus <- split_and_expand(df$`Focus of the study`)
manipulation <- split_and_expand(df$`Manipulation / intervention`)
focal.species <- split_and_expand(df$`The focal species is/are`)
ac.analysis <- split_and_expand(df$`Acoustic analysis`)
labels <- split_and_expand(df$`Labels`)
```

::: {.panel-tabset}
#### Type
```{r}
addmargins(sort(table(type), decreasing = TRUE)) %>% kable()
```

#### Primary VL evidence
```{r}
addmargins(sort(table(primary), decreasing = TRUE)) %>% kable()
```

#### Focus of study
```{r}
addmargins(sort(table(focus), decreasing = TRUE)) %>% kable()
```

#### Manipulation
```{r}
addmargins(sort(table(manipulation), decreasing = TRUE)) %>% kable()
```

#### Focal species are...
```{r}
addmargins(sort(table(focal.species), decreasing = TRUE)) %>% kable()
```

#### Acoustic analysis
```{r}
addmargins(sort(table(ac.analysis), decreasing = TRUE)) %>% kable()
```

#### Labels
```{r}
addmargins(sort(table(labels), decreasing = TRUE)) %>% kable()
```
:::



### Change over years

Here's the progress of the proportion (!) of studies on each taxon over the years. I'm plotting proportion of the total we have until the present day because this is arguably more representative of whether there has been a change in the attention paid to the VL capabilities of a particular taxon. I'm filtering out the 17 studies on `other`. The labels at the bottom mark when a taxon appears "for the first time" in the dataset

```{r, warning=FALSE, message=FALSE}
library(ggokabeito)

year <- as.integer(sub(".* (\\d{4})$", "\\1", df$`Study ID`))
dd <- data.frame(Year = year, Taxon = df$Taxa) %>%
      tidyr::separate_rows(Taxon, sep = ";\\s*") %>% 
      filter(Taxon != 'other')

totals <- table(dd$Taxon)
totals <- data.frame(Taxon = rownames(totals), Total = as.vector(unname(totals)))

#dd <- dd %>% left_join(totals)

d <- dd %>%
     count(Year, Taxon, name = 'n') %>%
     left_join(totals) %>%
     mutate(Prop = n / Total) %>%
     group_by(Taxon) %>% 
     group_split() %>% #splitting by Taxon because cumsum ignores groups
      purrr::map_dfr(~ .x %>%
    arrange(Year) %>%
    mutate(Proportion = cumsum(Prop))
    )

first_appearance_labels <- d %>%
  group_by(Taxon) %>%
  summarise(Year = min(Year), .groups = 'drop') %>%
  arrange(Year) %>%
  group_by(Year) %>%
  # Create a negative y-position sequence for labels within the same year
  mutate(label_y_pos = seq(from = -0.05, by = -0.04, length.out = n())) %>%
  ungroup()


d %>%
    ggplot(aes(x = Year, y = Proportion, col = Taxon, shape = Taxon)) + 
  geom_jitter(size = 4, alpha=0.7) +
      geom_text(
        data = first_appearance_labels,
        aes(x = Year, y = label_y_pos, label = Taxon),
        fontface = "bold",
        inherit.aes = FALSE,
        show.legend = FALSE # Hide these from the legend guide
        ) +
    theme_minimal(base_size = 25) +
    ylab('Proportion of studies on taxon') +
    theme(axis.title.x=element_blank(),
          legend.position = c(0.2, 0.7),
          legend.box.background = element_rect(fill = "white")) +
    scale_color_okabe_ito()
```

We can see that there's a general upward trend that is not quite linear -what you would expect if, across years, the proportion of studies on a taxon was steady. So there's more interest / more research on this line of research than back then. The progression from birds to primates; then a quick succession of pinnipeds, cetaceans and bats; and then a gap until elephants come in makes sense, matching both intuitions about clear(er)-cut cases of VL and the kinds of taxa we tend to study first. 


```{r, warning=FALSE, message=FALSE, eval=FALSE}
#OUTTAKE
year <- as.integer(sub(".* (\\d{4})$", "\\1", df$`Study ID`))
dd <- data.frame(Year = year, Taxon = df$Taxa) %>%
      tidyr::separate_rows(Taxon, sep = ";\\s*") %>% 
      filter(Taxon != 'other')

totals <- table(dd$Taxon)
totals <- data.frame(Taxon = rownames(totals), Total = as.vector(unname(totals)))

#dd <- dd %>% left_join(totals)

d <- dd %>%
     count(Year, Taxon, name = 'n') %>%
     left_join(totals) %>%
     mutate(Prop = n / Total) %>%
     group_by(Taxon) %>% 
     group_split() %>% #splitting by Taxon because cumsum ignores groups
      purrr::map_dfr(~ .x %>%
    arrange(Year) %>%
    mutate(Proportion = cumsum(Prop))
    )

first_appearance_labels <- d %>%
  group_by(Taxon) %>%
  summarise(Year = min(Year), .groups = 'drop') %>%
  arrange(Year) %>%
  group_by(Year) %>%
  # Create a negative y-position sequence for labels within the same year
  mutate(label_y_pos = seq(from = -0.05, by = -0.04, length.out = n())) %>%
  ungroup()


taxon_colors <- c(
  "birds" = "#1f77b4", 
  "primates" = "#ff7f0e", 
  "pinnipeds" = "#2ca02c", 
  "cetaceans" = "#d62728", 
  "bats" = "#9467bd", 
  "elephants" = "#8c564b"
)

taxon_emojis <- c(
  "birds" = "\U1F426", 
  "primates" = "\U1F412", 
  "pinnipeds" = "\U1F9AD", 
  "cetaceans" = "\U1F42C", 
  "bats" = "\U1F987", 
  "elephants" = "\U1F418"
)

d %>%
    mutate(emoji = taxon_emojis[as.character(Taxon)]) %>%
    ggplot(aes(x = Year, y = Proportion, col = Taxon, shape = emoji)) + 
  geom_text(aes(label = emoji), size = 4, alpha = 0.3, show.legend = FALSE) +
      geom_text(
        data = first_appearance_labels,
        aes(x = Year, y = label_y_pos, label = Taxon),
        fontface = "bold",
        inherit.aes = FALSE,
        show.legend = FALSE # Hide these from the legend guide
        ) +
    theme_minimal(base_size = 25) +
    ylab('Proportion of studies on taxon') +
  scale_color_manual(
    name = "Taxon",
    values = taxon_colors,
    labels = c("Birds", "Primates", "Pinnipeds", "Cetaceans", "Bats", "Elephants")
  ) +
    theme(axis.title.x=element_blank())

```